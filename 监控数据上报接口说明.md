# 监控数据上报接口说明文档

## 概述

本文档说明如何调用监控数据上报接口，适用于 MCP 服务端的监控数据上报场景。参考了 `@yqg/multiple-click` 工具库的实现方式，但针对服务端场景进行了简化（移除了多国家处理逻辑）。

## 接口地址

### 环境配置

MCP 服务端场景下，只需要使用测试环境的上报地址：

| 环境 | 上报地址 |
|------|---------|
| 测试环境 (`test`, `prod` 等) | `https://event-tracking-api-test.yangqianguan.com/logMetrics` |
| 开发环境 (`dev`) | 不上报（返回 null，仅打印日志） |

### URL 构建规则

```typescript
function getTrackingUrl(env: string): string | null {
  // MCP 服务端场景下，只需要测试环境
  if (env === 'dev') {
    return null;  // 开发环境不上报
  }
  
  // 其他环境统一使用测试环境地址
  return 'https://event-tracking-api-test.yangqianguan.com/logMetrics';
}
```

## 请求方式

- **方法**: `POST`
- **Content-Type**: `application/json;charset=UTF-8`

## 请求头（Headers）

| Header 名称 | 值 | 说明 |
|------------|-----|------|
| `YQG-PLATFORM-SDK-TYPE` | `{appId}` | 项目标识，例如：`MCP_SERVICE` |
| `CONTENT-TYPE` | `application/json;charset=UTF-8` | 固定值 |
| `Country` | `CN` | **注意**：MCP 服务端场景下，由于不需要处理多国家，可以固定为 `CN` 或从配置中获取 |

### 请求头示例

```typescript
const headers = {
  'YQG-PLATFORM-SDK-TYPE': appId,  // 例如: 'MCP_SERVICE'
  'CONTENT-TYPE': 'application/json;charset=UTF-8',
  'Country': 'CN'  // MCP 服务端固定为 CN，不需要从浏览器获取
};
```

## 请求体（Body）

### 数据结构

```typescript
interface TrackingRequest {
  level: 'INFO' | 'WARN' | 'ERROR';
  logs: Array<{
    appId: string;                    // 项目标识
    appVersion: string | null;         // 项目版本号（可选）
    osType: string | null;            // 操作系统类型（服务端可传 'Server' 或 null）
    measurement: string;               // 指标名称，例如: 'app_metrics_for_multiple_click'
    metricsType: string;               // 指标类型，例如: 'metricsType1'
    time: string;                      // 时间戳（毫秒），字符串格式
    message: string;                   // 消息描述
    parameter: Record<string, any>;    // 自定义的上报数据
  }>;
}
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `level` | `string` | 是 | 日志级别：`INFO`、`WARN`、`ERROR` |
| `logs` | `Array` | 是 | 日志数组，通常包含一条日志 |
| `logs[].appId` | `string` | 是 | 项目标识，例如：`MCP_SERVICE` |
| `logs[].appVersion` | `string \| null` | 否 | 项目版本号，可为 null |
| `logs[].osType` | `string \| null` | 否 | 操作系统类型，服务端可传 `'Server'` 或 `null` |
| `logs[].measurement` | `string` | 是 | 指标名称，根据业务场景自定义，例如：`'mcp_service_metrics'` |
| `logs[].metricsType` | `string` | 是 | 指标类型，例如：`'metricsType1'` |
| `logs[].time` | `string` | 是 | 时间戳（毫秒），使用 `Date.now().toString()` |
| `logs[].message` | `string` | 是 | 消息描述，简要说明上报的事件 |
| `logs[].parameter` | `object` | 是 | 自定义的上报数据，包含具体的监控信息 |

### 请求体示例

```json
{
  "level": "INFO",
  "logs": [
    {
      "appId": "MCP_SERVICE",
      "appVersion": "1.0.0",
      "osType": "Server",
      "measurement": "mcp_service_metrics",
      "metricsType": "metricsType1",
      "time": "1704067200000",
      "message": "mcp service monitoring",
      "parameter": {
        "eventType": "tool_call",
        "toolName": "some_tool",
        "duration": 150,
        "status": "success",
        "errorMessage": null
      }
    }
  ]
}
```

## 完整调用示例

### TypeScript 实现

```typescript
interface TrackingConfig {
  appId: string;
  appVersion?: string;
  env: string;
  customTrackingInfo: () => Record<string, any>;
}

/**
 * 获取上报 URL
 */
function getTrackingUrl(env: string): string | null {
  // MCP 服务端场景下，只需要测试环境
  if (env === 'dev') {
    return null;  // 开发环境不上报
  }
  
  // 其他环境统一使用测试环境地址
  return 'https://event-tracking-api-test.yangqianguan.com/logMetrics';
}

/**
 * 上报监控数据
 */
async function uploadTrackingInfo(config: TrackingConfig): Promise<void> {
  const { appId, appVersion, env, customTrackingInfo } = config;
  
  // 获取上报 URL
  const trackingUrl = getTrackingUrl(env);
  
  if (!trackingUrl) {
    console.info('无需上报监控数据，环境:', env);
    return;
  }
  
  // 构建请求头
  const headers = {
    'YQG-PLATFORM-SDK-TYPE': appId,
    'CONTENT-TYPE': 'application/json;charset=UTF-8',
    'Country': 'CN'  // MCP 服务端固定为 CN
  };
  
  // 获取自定义上报信息
  const trackingInfo = customTrackingInfo();
  
  // 构建请求体
  const requestBody = {
    level: 'INFO',
    logs: [
      {
        appId,
        appVersion: appVersion || null,
        osType: 'Server',  // 服务端固定为 Server
        measurement: 'mcp_service_metrics',  // 根据业务自定义
        metricsType: 'metricsType1',
        time: Date.now().toString(),
        message: 'mcp service monitoring',
        parameter: trackingInfo
      }
    ]
  };
  
  try {
    const response = await fetch(trackingUrl, {
      method: 'POST',
      headers,
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      console.error('监控数据上报失败:', response.status, response.statusText);
    }
  } catch (err) {
    console.error('监控数据上报异常:', err);
  }
}

// 使用示例
uploadTrackingInfo({
  appId: 'MCP_SERVICE',
  appVersion: '1.0.0',
  env: 'test',  // 或 'prod'，统一使用测试环境地址
  customTrackingInfo: () => ({
    eventType: 'tool_call',
    toolName: 'some_tool',
    duration: 150,
    status: 'success'
  })
});
```

### JavaScript 实现

```javascript
/**
 * 获取上报 URL
 */
function getTrackingUrl(env) {
  // MCP 服务端场景下，只需要测试环境
  if (env === 'dev') {
    return null;  // 开发环境不上报
  }
  
  // 其他环境统一使用测试环境地址
  return 'https://event-tracking-api-test.yangqianguan.com/logMetrics';
}

/**
 * 上报监控数据
 */
async function uploadTrackingInfo(config) {
  const { appId, appVersion, env, customTrackingInfo } = config;
  
  const trackingUrl = getTrackingUrl(env);
  
  if (!trackingUrl) {
    console.info('无需上报监控数据，环境:', env);
    return;
  }
  
  const headers = {
    'YQG-PLATFORM-SDK-TYPE': appId,
    'CONTENT-TYPE': 'application/json;charset=UTF-8',
    'Country': 'CN'
  };
  
  const trackingInfo = customTrackingInfo();
  
  const requestBody = {
    level: 'INFO',
    logs: [
      {
        appId,
        appVersion: appVersion || null,
        osType: 'Server',
        measurement: 'mcp_service_metrics',
        metricsType: 'metricsType1',
        time: Date.now().toString(),
        message: 'mcp service monitoring',
        parameter: trackingInfo
      }
    ]
  };
  
  try {
    const response = await fetch(trackingUrl, {
      method: 'POST',
      headers,
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      console.error('监控数据上报失败:', response.status, response.statusText);
    }
  } catch (err) {
    console.error('监控数据上报异常:', err);
  }
}
```

## 与 multiple-click 库的区别

| 特性 | multiple-click（浏览器端） | MCP 服务端场景 |
|------|---------------------------|---------------|
| **国家信息获取** | 从浏览器 `navigator.userAgent` 或 `navigator.language` 解析 | 固定为 `CN` 或从配置获取 |
| **操作系统类型** | 从 `userAgent` 解析（Windows、iOS、MacOS、Android 等） | 固定为 `Server` |
| **环境判断** | 支持多国家多环境（印尼、墨西哥、菲律宾等） | 简化环境判断，仅需区分 dev/非dev（非dev统一使用测试环境） |
| **上报时机** | 监听浏览器点击事件 | 根据业务逻辑主动调用 |
| **自定义数据** | 包含 DOM 元素信息（outerHTML、selector、位置等） | 根据业务需求自定义监控数据 |

## 工具类设计建议

### 配置接口

```typescript
interface MCPTrackingConfig {
  /** 项目标识 */
  appId: string;
  
  /** 项目版本号（可选） */
  appVersion?: string;
  
  /** 环境：dev（不上报）、test、prod（统一使用测试环境地址） */
  env: string;
  
  /** 指标名称（可选，默认：mcp_service_metrics） */
  measurement?: string;
  
  /** 指标类型（可选，默认：metricsType1） */
  metricsType?: string;
}
```

### 核心方法

```typescript
class MCPTrackingService {
  private config: MCPTrackingConfig;
  
  constructor(config: MCPTrackingConfig) {
    this.config = config;
  }
  
  /**
   * 上报监控数据
   * @param parameter 自定义的上报数据
   * @param level 日志级别，默认 INFO
   * @param message 消息描述，默认 'mcp service monitoring'
   */
  async track(
    parameter: Record<string, any>,
    level: 'INFO' | 'WARN' | 'ERROR' = 'INFO',
    message: string = 'mcp service monitoring'
  ): Promise<void> {
    // 实现上报逻辑
  }
}
```

## 注意事项

1. **错误处理**：上报失败不应影响主业务流程，建议使用 `try-catch` 捕获异常
2. **性能考虑**：上报操作建议异步执行，避免阻塞主流程
3. **开发环境**：开发环境下不上报，仅打印日志，便于调试
4. **数据格式**：确保 `parameter` 字段中的数据可被 JSON 序列化
5. **时间戳**：使用 `Date.now().toString()` 生成毫秒级时间戳字符串

## 参考

- 原始实现：`@yqg/multiple-click` 工具库
- 相关文件：
  - `packages/multiple-click/src/config.ts` - 上报逻辑实现
  - `packages/multiple-click/src/constant.ts` - 环境配置常量
  - `packages/multiple-click/src/utils.ts` - 工具函数（浏览器端专用）

